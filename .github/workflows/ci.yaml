name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    # Run pipeline on version tags for releases
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]

# Global permissions (Least Privilege)
permissions:
  contents: read

env:
  TF_VERSION: 1.8.4
  NODE_VERSION: 20

jobs:
  # ------------------------------------------------------------------------
  # JOB 1: LINTING (Runs in parallel)
  # ------------------------------------------------------------------------
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      # âœ… CHECKOUT MUST RUN FIRST to download the code and lock files
      - uses: actions/checkout@v4

      - name: Setup Node.js (with caching)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          # This pattern searches for package-lock.json in root and subdirectories
          cache-dependency-path: '**/package-lock.json'

      - name: Validate shell scripts
        run: shellcheck -x **/*.sh

      - name: Lint Dockerfile
        run: |
          wget -q -O /tmp/hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x /tmp/hadolint
          /tmp/hadolint app/Dockerfile || true

      - name: Validate JSON files
        run: |
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./.terraform/*" | while read f; do
            echo "Validating $f..."
            jq empty "$f" || exit 1
          done

      - name: Lint YAML files
        run: |
          pip install yamllint
          yamllint -c '{extends: default, rules: {line-length: {max: 120}, comments: {min-spaces-from-content: 1}}}' \
            .github/ terraform/ 2>/dev/null || true

      - name: Validate documentation links
        run: |
          npm install -g markdown-link-check
          find . -name "*.md" -not -path "./node_modules/*" -exec markdown-link-check --quiet {} \;

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  # ------------------------------------------------------------------------
  # JOB 2: TERRAFORM VALIDATION (Runs in parallel with Matrix Strategy)
  # ------------------------------------------------------------------------
  terraform-validate:
    name: Terraform Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test against the project version and the latest stable
        tf-version: [1.8.4, 1.9.0]
    
    steps:
      - uses: actions/checkout@v4

      - name: Cache Terraform
        uses: actions/cache@v3
        with:
          path: |
            terraform/.terraform
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.tf-version }}-${{ hashFiles('terraform/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.tf-version }}-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ matrix.tf-version }}

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

  # ------------------------------------------------------------------------
  # JOB 3: SECURITY SCANNING (Runs in parallel)
  # ------------------------------------------------------------------------
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

  # ------------------------------------------------------------------------
  # JOB 4: BUILD (Sequential - Runs after checks pass)
  # ------------------------------------------------------------------------
  build:
    name: Build Artifacts
    needs: [lint, terraform-validate, security]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' # Only build on push, not PRs (unless PR builds are desired)
    steps:
      - uses: actions/checkout@v4
      
      - name: Create release archives
        run: |
          mkdir -p dist/
          
          # Copy documentation files
          cp README.md dist/README.md
          cp CONTRIBUTING.md dist/CONTRIBUTING.md
          cp SECURITY.md dist/SECURITY.md
          cp CODE_OF_CONDUCT.md dist/CODE_OF_CONDUCT.md
          cp LICENSE dist/LICENSE
          
          # Create archives
          tar -czf dist/app.tar.gz app/
          tar -czf dist/terraform.tar.gz terraform/
          tar -czf dist/scripts.tar.gz scripts/
          tar -czf dist/host-setup.tar.gz 2-host-setup/
          tar -czf dist/gcp-setup.tar.gz 1-gcp-setup/
          tar -czf dist/cloud-run.tar.gz 3-cloud-run-deployment/
          tar -czf dist/gke.tar.gz 3-gke-deployment/
          
          # Generate checksums
          cd dist
          sha256sum *.tar.gz *.md LICENSE > sha256sums.txt
          cd ..
      
      - name: Upload Artifacts for Release
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/
          retention-days: 1

  # ------------------------------------------------------------------------
  # JOB 5: RELEASE (Runs only on tags)
  # ------------------------------------------------------------------------
  release:
    name: Create GitHub Release
    needs: [build]
    runs-on: ubuntu-latest
    # Only run this job if a tag is pushed
    if: startsWith(github.ref, 'refs/tags/')
    
    # Environment protection for production releases
    environment: 
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}

    permissions:
      contents: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            dist/sha256sums.txt
            dist/README.md
            dist/CONTRIBUTING.md
            dist/SECURITY.md
            dist/CODE_OF_CONDUCT.md
            dist/LICENSE
            dist/app.tar.gz
            dist/terraform.tar.gz
            dist/scripts.tar.gz
            dist/host-setup.tar.gz
            dist/gcp-setup.tar.gz
            dist/cloud-run.tar.gz
            dist/gke.tar.gz
          body: |
            ## ðŸ“¦ Release Archives
            
            This release provides organized archives for each component:
            
            ### Core Components
            - **app.tar.gz** - Node.js application and Dockerfile
            - **terraform.tar.gz** - Infrastructure as Code configurations
            - **scripts.tar.gz** - Utility and validation scripts
            
            ### Setup Scripts
            - **host-setup.tar.gz** - VM configuration scripts (Phase 2)
            - **gcp-setup.tar.gz** - GCP project setup scripts (Phase 1)
            - **cloud-run.tar.gz** - Cloud Run deployment scripts (Phase 3)
            - **gke.tar.gz** - Kubernetes/GKE deployment scripts (Phase 4)
            
            ### Documentation
            - **README.md** - Complete project documentation
            - **CONTRIBUTING.md** - Contribution guidelines
            - **SECURITY.md** - Security policies
            - **CODE_OF_CONDUCT.md** - Community guidelines
            - **LICENSE** - MIT License
            
            ## ðŸ“¥ Quick Start
            
            ```bash
            # Download and extract an archive
            wget [https://github.com/$](https://github.com/$){{ github.repository }}/releases/download/${{ github.ref_name }}/app.tar.gz
            tar -xzf app.tar.gz
            
            # Verify checksums
            wget [https://github.com/$](https://github.com/$){{ github.repository }}/releases/download/${{ github.ref_name }}/sha256sums.txt
            sha256sum -c sha256sums.txt
            ```
            
            ## âœ… Verification
            
            All files include SHA256 checksums in `sha256sums.txt` for integrity verification.